{% extends "base.html" %}
{% block title %}Epic — ProjectMan{% endblock %}

{% block content %}
<div class="breadcrumb"><a href="/epics">Epics</a> <span>/</span> {{ epic_id }}</div>

<dialog id="dlg-new-story">
  <article>
    <header>
      <h3>Add Story to Epic</h3>
      <button class="close-btn" onclick="this.closest('dialog').close()">&times;</button>
    </header>
    <form id="form-new-story" onsubmit="return submitNewStory(event)">
      <label>Title <input type="text" name="title" required></label>
      <label>Description <textarea name="description" rows="3" required></textarea></label>
      <label>Priority
        <select name="priority"><option value="">— none —</option><option value="must">must</option><option value="should">should</option><option value="could">could</option><option value="wont">wont</option></select>
      </label>
      <label>Points
        <select name="points"><option value="">— none —</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="5">5</option><option value="8">8</option><option value="13">13</option></select>
      </label>
      <footer>
        <button type="button" class="secondary outline" onclick="this.closest('dialog').close()">Cancel</button>
        <button type="submit">Create Story</button>
      </footer>
    </form>
  </article>
</dialog>

<div id="epic-detail" hx-get="/api/epics/{{ epic_id }}" hx-trigger="load" hx-swap="innerHTML">
  <p aria-busy="true">Loading epic...</p>
</div>

<script>
document.addEventListener("htmx:afterRequest", function(evt) {
  if (evt.detail.pathInfo && evt.detail.pathInfo.requestPath.match(/^\/api\/epics\/[^/]+$/)) {
    var data = JSON.parse(evt.detail.xhr.responseText);
    var target = document.getElementById("epic-detail");
    var e = data.epic;
    var r = data.rollup;
    var pct = parseInt(r.completion) || 0;

    var html = '<div class="detail-header"><h1>' + e.title + '</h1>' +
      '<div class="detail-meta">' +
      '<span class="badge badge-' + e.status + '">' + e.status + '</span>' +
      (e.priority ? '<span class="badge badge-' + e.priority + '">' + e.priority + '</span>' : '') +
      '<code>' + e.id + '</code>' +
      '</div></div>';

    // Rollup stat cards — clickable
    html += '<div class="stat-grid">' +
      '<a href="/stories" class="stat-card"><div class="stat-value">' + r.story_count + '</div><div class="stat-label">Stories</div></a>' +
      '<div class="stat-card"><div class="stat-value">' + r.total_points + '</div><div class="stat-label">Points</div></div>' +
      '<div class="stat-card"><div class="stat-value">' + r.completed_points + '</div><div class="stat-label">Completed</div></div>' +
      '<div class="stat-card"><div class="stat-value">' + r.completion + '</div><div class="stat-label">Done</div></div>' +
      '</div>';
    html += '<div class="progress-bar progress-bar-lg" style="margin-bottom:1.5rem"><div class="progress-bar-fill" style="width:' + pct + '%"></div></div>';

    // Description
    if (data.body) {
      html += '<div class="section-card"><h3>Description</h3><p>' + data.body.replace(/\n/g, '<br>') + '</p></div>';
    }

    // Linked stories
    html += '<div class="section-card"><div class="page-heading"><h3>Stories</h3>' +
      '<button class="btn-create" onclick="document.getElementById(\'dlg-new-story\').showModal()">+ Add Story</button></div>';
    if (data.stories && data.stories.length > 0) {
      html += '<table role="grid"><thead><tr><th>ID</th><th>Title</th><th>Status</th><th>Points</th><th>Progress</th></tr></thead><tbody>';
      data.stories.forEach(function(s) {
        var sp = s.done_points && s.task_points ? Math.round(s.done_points / s.task_points * 100) : 0;
        html += '<tr class="clickable-row" onclick="window.location=\'/stories/' + s.id + '\'">' +
          '<td><a href="/stories/' + s.id + '">' + s.id + '</a></td>' +
          '<td><strong>' + s.title + '</strong></td>' +
          '<td><span class="badge badge-' + s.status + '">' + s.status + '</span></td>' +
          '<td>' + (s.points || '—') + '</td>' +
          '<td><div class="progress-bar"><div class="progress-bar-fill" style="width:' + sp + '%"></div></div></td>' +
          '</tr>';
      });
      html += '</tbody></table>';
    } else {
      html += '<p class="muted">No stories yet.</p>';
    }
    html += '</div>';

    // Actions
    html += '<div class="section-card"><h3>Actions</h3>' +
      '<form onsubmit="return updateEpicStatus(event)">' +
      '<fieldset role="group">' +
      '<select id="epic-status">' +
      '<option value="draft"' + (e.status === "draft" ? ' selected' : '') + '>Draft</option>' +
      '<option value="active"' + (e.status === "active" ? ' selected' : '') + '>Active</option>' +
      '<option value="done"' + (e.status === "done" ? ' selected' : '') + '>Done</option>' +
      '</select>' +
      '<button type="submit">Update Status</button>' +
      '</fieldset></form></div>';

    target.innerHTML = html;
  }
});

function submitNewStory(evt) {
  evt.preventDefault();
  var form = document.getElementById("form-new-story");
  var fd = new FormData(form);
  var body = {
    title: fd.get("title"),
    description: fd.get("description"),
    epic_id: "{{ epic_id }}",
  };
  if (fd.get("priority")) body.priority = fd.get("priority");
  if (fd.get("points")) body.points = parseInt(fd.get("points"));
  fetch("/api/stories", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(body),
  }).then(function(r) {
    if (!r.ok) throw new Error(r.status);
    return r.json();
  }).then(function(data) {
    document.getElementById("dlg-new-story").close();
    form.reset();
    showToast("Story created: " + data.id);
    htmx.ajax("GET", "/api/epics/{{ epic_id }}", "#epic-detail");
  }).catch(function() { showToast("Failed to create story", "error"); });
  return false;
}

function updateEpicStatus(evt) {
  evt.preventDefault();
  var status = document.getElementById("epic-status").value;
  fetch("/api/epics/{{ epic_id }}", {
    method: "PATCH",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({status: status}),
  }).then(function(r) { return r.json(); })
    .then(function(data) {
      showToast("Status updated to " + data.status);
      htmx.ajax("GET", "/api/epics/{{ epic_id }}", "#epic-detail");
    });
  return false;
}
</script>
{% endblock %}
